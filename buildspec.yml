version: 0.2

phases:
install:
runtime-versions:
nodejs: 18
pre_build:
commands:
- echo "Running unit tests..."
- npm ci
- npm test
build:
commands:
- echo "Logging in to Amazon ECR..."
- aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_https://www.google.com/search?q=REGION.amazonaws.com
- REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.AWS_https://www.google.com/search?q=REGION.amazonaws.com/\-IMAGE_TAG=(echo $CODEBUILD_BUILD_ID | cut -d: -f2)
- echo "Building the Docker image..."
- docker build -t $REPOSITORY_URI:$IMAGE_TAG .
- docker tag $REPOSITORY_URI:$IMAGE_TAG $REPOSITORY_URI:latest
post_build:
commands:
- echo "Pushing the Docker images to ECR..."
- docker push $REPOSITORY_URI:$IMAGE_TAG
- docker push $REPOSITORY_URI:latest
- echo "Creating imagedefinitions.json for ECS deployment..."
- printf '[{"name":"%s","imageUri":"%s"}]' $CONTAINER_NAME $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json

artifacts:
files:
- imagedefinitions.json